<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>XR Video (AR/MR)</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    #overlay{
      position:fixed;inset:0;display:grid;place-items:center;
      background:rgba(0,0,0,.85);color:#fff;font-family:system-ui,Arial;
      z-index:10;text-align:center;padding:24px;
    }
    .card{
      max-width:820px;width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;padding:20px;
    }
    button{
      padding:14px 18px;border-radius:14px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.1);
      color:#fff;cursor:pointer;margin:6px;
    }
    .small{
      opacity:.75;font-size:14px;line-height:1.4;margin-top:10px;
      white-space:pre-wrap;text-align:left
    }
  </style>
</head>
<body>

<div id="overlay">
  <div class="card">
    <h2 style="margin:0 0 10px 0;">Modo passthrough (AR)</h2>
    <p style="margin:0 0 14px 0;opacity:.9;">
      Texto centrado con efecto escritura (sin desplazarse)
    </p>
    <div>
      <button id="start">1) Iniciar v√≠deo</button>
      <button id="enterAR" disabled>2) Entrar en AR</button>
      <button id="enterVR" disabled>Entrar en VR</button>
    </div>
    <div class="small" id="log"></div>
  </div>
</div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import { CUES, VIDEO_URL } from "./cues.js";

const overlay = document.getElementById("overlay");
const logEl = document.getElementById("log");
const log = m => logEl.textContent += (logEl.textContent ? "\n" : "") + m;

/* ---------- Fuente PRISTINA ---------- */
let PRISTINA_READY = false;
const font = new FontFace("PristinaAR", "url(./PRISTINA.TTF)");
await font.load();
document.fonts.add(font);
PRISTINA_READY = true;

/* ---------- THREE / XR ---------- */
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = null;

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 50);
camera.position.set(0, 1.6, 2);

scene.add(new THREE.HemisphereLight(0xffffff,0x222222,1.2));

/* ---------- VIDEO (loop) ---------- */
const video = document.createElement("video");
video.src = VIDEO_URL;
video.muted = true;
video.loop = true;
video.playsInline = true;
video.setAttribute("playsinline","");
video.preload = "auto";
video.style.position="fixed";
video.style.left="-9999px";
document.body.appendChild(video);

const videoTex = new THREE.VideoTexture(video);
const screen = new THREE.Mesh(
  new THREE.PlaneGeometry(1.6,0.9),
  new THREE.MeshBasicMaterial({ map: videoTex })
);
screen.position.set(0, 1.55, -1.25);   // üîπ M√ÅS CERCA
scene.add(screen);

/* ---------- TEXTO: CANVAS FIJO ---------- */
const textCanvas = document.createElement("canvas");
const ctx = textCanvas.getContext("2d");

textCanvas.width  = 1600;
textCanvas.height = 420;

const textTex = new THREE.CanvasTexture(textCanvas);
const aspect = textCanvas.width / textCanvas.height;
const planeH = 0.32;
const planeW = planeH * aspect;

const textPlane = new THREE.Mesh(
  new THREE.PlaneGeometry(planeW, planeH),
  new THREE.MeshBasicMaterial({ map:textTex, transparent:true, depthWrite:false })
);
textPlane.position.set(0, 1.18, -0.9);   // üîπ TEXTO M√ÅS CERCA
scene.add(textPlane);

const FONT = "56px PristinaAR";
const LINE_H = 86;
const PAD_Y = 60;

/* ---------- ESCRITURA CENTRADA ---------- */
let fullText = "";
let cursor = 0;
let timeNext = 0;
let centerX = textCanvas.width / 2;

function drawCentered(text) {
  ctx.clearRect(0,0,textCanvas.width,textCanvas.height);
  ctx.font = FONT;
  ctx.fillStyle = "rgba(255,255,255,0.96)";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  ctx.shadowColor = "rgba(0,0,0,0.85)";
  ctx.shadowBlur = 20;

  let y = PAD_Y;
  for (const line of text.split("\n")) {
    ctx.fillText(line, centerX, y);
    y += LINE_H;
  }
  textTex.needsUpdate = true;
}

function startWriting(lines) {
  fullText = (Array.isArray(lines)?lines:[String(lines)]).join("\n");
  cursor = 0;
  timeNext = 0;
  drawCentered("");
}

function stepWriting(dt) {
  if (cursor >= fullText.length) return;
  timeNext -= dt;
  if (timeNext <= 0) {
    cursor++;
    drawCentered(fullText.slice(0,cursor));
    const cps = 22 + Math.random()*12;
    timeNext = 1 / cps;
  }
}

/* ---------- CUES ---------- */
const cues = [...CUES].sort((a,b)=>a.t-b.t);
let nextCue = 0;
let lastT = 0;

renderer.setAnimationLoop(()=>{
  const t = video.currentTime;

  if (t < lastT) { nextCue = 0; drawCentered(""); }
  lastT = t;

  while (nextCue < cues.length && t >= cues[nextCue].t) {
    startWriting(cues[nextCue].text);
    nextCue++;
  }

  stepWriting(0.016);
  renderer.render(scene,camera);
});

/* ---------- UI ---------- */
document.getElementById("start").onclick = async()=>{
  await video.play();
  document.getElementById("enterAR").disabled=false;
  document.getElementById("enterVR").disabled=false;
};

document.getElementById("enterAR").onclick = async()=>{
  const s = await navigator.xr.requestSession("immersive-ar",{optionalFeatures:["local-floor"]});
  renderer.xr.setSession(s);
  overlay.style.display="none";
};

document.getElementById("enterVR").onclick = async()=>{
  const s = await navigator.xr.requestSession("immersive-vr");
  renderer.xr.setSession(s);
  overlay.style.display="none";
};
</script>
</body>
</html>
