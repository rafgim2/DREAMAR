// ---------- VIDEO (ajustes QUEST, más estrictos) ----------
const video = document.createElement("video");
video.src = VIDEO_URL;
video.crossOrigin = "anonymous";

// CLAVES Quest
video.muted = true;
video.setAttribute("muted", ""); // a veces necesario
video.volume = 0;               // redundante, pero ayuda
video.playsInline = true;
video.setAttribute("playsinline", "");
video.setAttribute("webkit-playsinline", "");
video.preload = "auto";
video.loop = false;

// IMPORTANTE: algunos navegadores XR solo decodifican si el video está en el DOM
video.style.position = "fixed";
video.style.left = "-9999px";
video.style.top = "-9999px";
video.width = 1;
video.height = 1;
document.body.appendChild(video);

// pantalla flotante
const videoTex = new THREE.VideoTexture(video);
videoTex.colorSpace = THREE.SRGBColorSpace;

const screen = new THREE.Mesh(
  new THREE.PlaneGeometry(1.6, 0.9),
  new THREE.MeshBasicMaterial({ map: videoTex })
);
screen.position.set(0, 1.6, -2.2);
scene.add(screen);

// ---------- Start flow (con error visible) ----------
const overlay = document.getElementById("overlay");
const startBtn = document.getElementById("start");

function showOverlayError(msg) {
  overlay.style.display = "grid";
  overlay.querySelector(".card").innerHTML = `
    <h2 style="margin:0 0 10px 0;">No se pudo iniciar el vídeo</h2>
    <div style="opacity:.9;white-space:pre-wrap;text-align:left">${msg}</div>
    <div class="small" style="margin-top:12px;opacity:.75">
      Si el MP4 va en PC pero falla en Quest, casi siempre es perfil/level/bitrate/fps.
    </div>
  `;
}

startBtn.addEventListener("click", async () => {
  try {
    // fuerza recarga
    video.load();

    // intenta reproducir por gesto
    const p = video.play();
    if (p && typeof p.then === "function") await p;

    // si llega aquí, ya decodifica
    resyncCues(video.currentTime);

    document.body.appendChild(VRButton.createButton(renderer));
    overlay.style.display = "none";
  } catch (e) {
    console.error(e);
    showOverlayError(`${e?.name || "Error"}: ${e?.message || String(e)}`);
  }
});
