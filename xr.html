<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>XR Video + Texto 3D</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    #overlay{
      position:fixed;inset:0;
      display:grid;place-items:center;
      background:rgba(0,0,0,.88);
      color:#fff;font-family:system-ui,Arial;
      z-index:10;
      text-align:center;
      padding:24px;
    }
    .card{
      max-width:760px;width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:20px;
    }
    button{
      padding:14px 18px;border-radius:14px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.1);
      color:#fff;cursor:pointer;
    }
    .small{opacity:.75;font-size:14px;line-height:1.4;margin-top:10px}
  </style>
</head>
<body>

<div id="overlay">
  <div class="card">
    <h2 style="margin:0 0 10px 0;">XR listo</h2>
    <p style="margin:0 0 14px 0;opacity:.9;">
      Pulsa para iniciar el vídeo y entrar en VR.
    </p>
    <button id="start">Iniciar vídeo y mostrar “Enter VR”</button>
    <div class="small">Texto extruido 3D + pantalla más cerca.</div>
  </div>
</div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
  import { VRButton } from "https://unpkg.com/three@0.160.0/examples/jsm/webxr/VRButton.js";
  import { FontLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/FontLoader.js";
  import { TextGeometry } from "https://unpkg.com/three@0.160.0/examples/jsm/geometries/TextGeometry.js";
  import { CUES, VIDEO_URL } from "./cues.js";

  // ---------- Three.js ----------
  const renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000000);

  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 50);
  camera.position.set(0,1.6,2);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1.2));
  const dir = new THREE.DirectionalLight(0xffffff, 0.9);
  dir.position.set(1,2,1);
  scene.add(dir);

  // suelo sutil
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(20,20),
    new THREE.MeshStandardMaterial({ color:0x050505, roughness:1 })
  );
  floor.rotation.x = -Math.PI/2;
  floor.position.y = 0;
  scene.add(floor);

  // ---------- Vídeo (Quest-safe) ----------
  const video = document.createElement("video");
  video.src = VIDEO_URL;
  video.crossOrigin = "anonymous";
  video.muted = true;
  video.setAttribute("muted","");
  video.volume = 0;
  video.playsInline = true;
  video.setAttribute("playsinline","");
  video.setAttribute("webkit-playsinline","");
  video.preload = "auto";
  video.loop = false;

  // meterlo en el DOM (ayuda a Quest)
  video.style.position = "fixed";
  video.style.left = "-9999px";
  video.style.top = "-9999px";
  video.width = 1;
  video.height = 1;
  document.body.appendChild(video);

  const videoTex = new THREE.VideoTexture(video);
  videoTex.colorSpace = THREE.SRGBColorSpace;

  const screen = new THREE.Mesh(
    new THREE.PlaneGeometry(1.6, 0.9),
    new THREE.MeshBasicMaterial({ map: videoTex })
  );
  // ✅ más cerca
  screen.position.set(0, 1.6, -1.4);
  scene.add(screen);

  // panel oscuro detrás (modo cine)
  const dimmer = new THREE.Mesh(
    new THREE.PlaneGeometry(6, 4),
    new THREE.MeshBasicMaterial({ color:0x000000, transparent:true, opacity:0.55 })
  );
  dimmer.position.set(0, 1.6, -1.75);
  scene.add(dimmer);

  // ---------- Texto 3D extruido ----------
  let font = null;
  const fontLoader = new FontLoader();

  // Fuente JSON de Three (helvetiker). Es un JSON, no una “web font”.
  // (CDN de threejs.org)
  const FONT_URL = "https://threejs.org/examples/fonts/helvetiker_regular.typeface.json";

  const textGroup = new THREE.Group();
  scene.add(textGroup);

  // Material del texto (blanco suave)
  const textMat = new THREE.MeshStandardMaterial({
    color: 0xffffff,
    roughness: 0.35,
    metalness: 0.0
  });

  function clearText3D(){
    while (textGroup.children.length) {
      const m = textGroup.children.pop();
      m.geometry?.dispose?.();
      // no hacemos dispose de material global
    }
  }

  function setText3D(lines){
    if (!font) return;
    clearText3D();

    const safeLines = Array.isArray(lines) ? lines : [String(lines)];

    // Parámetros del texto: ajusta si lo quieres más grande
    const size = 0.07;      // tamaño en metros
    const height = 0.015;   // extrusión (grosor)
    const curveSegments = 8;
    const bevelEnabled = true;
    const bevelThickness = 0.004;
    const bevelSize = 0.0025;
    const bevelSegments = 3;

    // Construimos cada línea como mesh independiente
    const lineMeshes = [];
    for (const line of safeLines) {
      const geo = new TextGeometry(line, {
        font,
        size,
        height,
        curveSegments,
        bevelEnabled,
        bevelThickness,
        bevelSize,
        bevelSegments,
      });
      geo.computeBoundingBox();
      geo.center(); // centra cada línea en X/Y local

      const mesh = new THREE.Mesh(geo, textMat);
      lineMeshes.push(mesh);
      textGroup.add(mesh);
    }

    // Apilado vertical (líneas una debajo de otra)
    const lineSpacing = 0.10; // separación entre líneas (metros)
    const totalH = (safeLines.length - 1) * lineSpacing;
    lineMeshes.forEach((m, i) => {
      m.position.y = (totalH / 2) - i * lineSpacing;
    });

    // ✅ más cerca y un pelín por debajo de la pantalla
    textGroup.position.set(0, 1.25, -1.05);
  }

  // el texto mira al usuario
  function faceCamera(){
    textGroup.quaternion.copy(camera.quaternion);
  }

  // Carga de fuente (una vez)
  fontLoader.load(
    FONT_URL,
    (loaded) => { font = loaded; },
    undefined,
    (err) => { console.error("No se pudo cargar la fuente:", err); }
  );

  // ---------- Cues ----------
  const cues = [...CUES].sort((a,b)=>a.t-b.t);
  let nextCue = 0;

  function resyncCues(t){
    let idx = -1;
    for (let i=0;i<cues.length;i++){
      if (cues[i].t <= t) idx = i; else break;
    }
    nextCue = idx + 1;
    if (idx >= 0) setText3D(cues[idx].text);
  }

  // ---------- Loop ----------
  renderer.setAnimationLoop(()=>{
    if (video.readyState >= 2) videoTex.needsUpdate = true;

    if (!video.paused && !video.ended && font) {
      const t = video.currentTime;
      while (nextCue < cues.length && t >= cues[nextCue].t) {
        setText3D(cues[nextCue].text);
        nextCue++;
      }
    }

    faceCamera();
    renderer.render(scene, camera);
  });

  window.addEventListener("resize", ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // ---------- Start ----------
  const overlay = document.getElementById("overlay");
  document.getElementById("start").addEventListener("click", async ()=>{
    try{
      video.load();
      const p = video.play();
      if (p && p.then) await p;

      resyncCues(video.currentTime);

      document.body.appendChild(VRButton.createButton(renderer));
      overlay.style.display = "none";
    }catch(e){
      console.error(e);
      alert(`${e?.name||"Error"}: ${e?.message||e}`);
    }
  });
</script>
</body>
</html>
