<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>XR Video AR</title>

<style>
html,body{
  margin:0;height:100%;overflow:hidden;background:#000;
  font-family:system-ui,Arial;
}
#overlay{
  position:fixed;inset:0;
  display:grid;place-items:center;
  background:rgba(0,0,0,.85);
  color:white;z-index:10;
}
.card{
  background:rgba(255,255,255,.08);
  padding:20px;border-radius:18px;
  max-width:820px;width:100%;
  text-align:center;
}
button{
  padding:14px 18px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.12);
  color:white;
  cursor:pointer;
  margin:6px;
}
.small{
  opacity:.7;font-size:14px;
  margin-top:10px;
  text-align:left;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div id="overlay">
  <div class="card">
    <h2>Experiencia AR</h2>
    <p>Inicia el v√≠deo (con sonido) y entra en AR</p>
    <button id="start">‚ñ∂ Iniciar v√≠deo</button>
    <button id="enterAR" disabled>Entrar en AR</button>
    <button id="enterVR" disabled>Entrar en VR</button>
    <div class="small" id="log"></div>
  </div>
</div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import { VIDEO_URL, CUES } from "./cues.js";

const logEl = document.getElementById("log");
const log = m => logEl.textContent += (logEl.textContent ? "\n":"") + m;
const overlay = document.getElementById("overlay");

/* -------------------- FUENTE PRISTINA -------------------- */
let FONT_READY=false;
async function loadFont(){
  try{
    const f=new FontFace("PristinaAR","url(./PRISTINA.TTF)");
    await f.load(); document.fonts.add(f);
    FONT_READY=true;
  }catch{}
}
await loadFont();
const fontName=()=>FONT_READY?"PristinaAR":"serif";

/* -------------------- THREE / XR -------------------- */
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.xr.enabled=true;
document.body.appendChild(renderer.domElement);

const scene=new THREE.Scene();
scene.background=null;

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,50);
camera.position.set(0,1.6,2);

scene.add(new THREE.HemisphereLight(0xffffff,0x222222,1.2));

/* -------------------- VIDEO + AUDIO -------------------- */
const video=document.createElement("video");
video.src=VIDEO_URL;
video.crossOrigin="anonymous";
video.loop=true;
video.preload="auto";
video.playsInline=true;
video.setAttribute("playsinline","");
video.setAttribute("webkit-playsinline","");

video.muted=false;        // üîä AUDIO ON
video.volume=1.0;

video.style.position="fixed";
video.style.left="-9999px";
document.body.appendChild(video);

const videoTex=new THREE.VideoTexture(video);
videoTex.colorSpace=THREE.SRGBColorSpace;

const screen=new THREE.Mesh(
  new THREE.PlaneGeometry(1.6,0.9),
  new THREE.MeshBasicMaterial({map:videoTex})
);
screen.position.set(0,1.55,-1.35);
scene.add(screen);

/* -------------------- TEXTO (ESCRITURA ESTABLE) -------------------- */
const pad=36, fontPx=56, lineH=78;
let canvas,ctx,texture,plane;
let fullLines=[],fullWidths=[],fullText="";
let cursor=0,nextT=0,lastT=0;

function setupText(lines){
  fullLines=Array.isArray(lines)?lines:[lines];
  const m=document.createElement("canvas").getContext("2d");
  m.font=`${fontPx}px ${fontName()}`;
  fullWidths=fullLines.map(l=>m.measureText(l).width);
  const w=Math.max(...fullWidths)+pad*2;
  const h=fullLines.length*lineH+pad*2;

  canvas=document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  ctx=canvas.getContext("2d");

  texture=new THREE.CanvasTexture(canvas);
  texture.minFilter=THREE.LinearFilter;
  texture.magFilter=THREE.LinearFilter;

  if(plane){
    plane.material.dispose();
    plane.geometry.dispose();
    scene.remove(plane);
  }

  const aspect=w/h;
  plane=new THREE.Mesh(
    new THREE.PlaneGeometry(0.3*aspect,0.3),
    new THREE.MeshBasicMaterial({map:texture,transparent:true,depthWrite:false})
  );
  plane.position.set(0,1.65,-1.05);
  scene.add(plane);

  fullText=fullLines.join("\n");
  cursor=0; nextT=0;
  draw(0);
}

function draw(chars){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.font=`${fontPx}px ${fontName()}`;
  ctx.fillStyle="rgba(255,255,255,.96)";
  ctx.shadowColor="rgba(0,0,0,.85)";
  ctx.shadowBlur=20;
  ctx.textAlign="center";
  ctx.textBaseline="middle";

  const visible=fullText.slice(0,chars).split("\n");
  let y=pad+lineH/2, cx=canvas.width/2;

  for(let i=0;i<fullLines.length;i++){
    const full=fullLines[i];
    const vis=visible[i]||"";
    const left=cx-fullWidths[i]/2;
    const vw=ctx.measureText(vis).width;

    ctx.save();
    ctx.beginPath();
    ctx.rect(left,y-lineH/2,vw,lineH);
    ctx.clip();
    ctx.fillText(full,cx,y);
    ctx.restore();
    y+=lineH;
  }
  texture.needsUpdate=true;
}

function step(dt){
  if(cursor>=fullText.length) return;
  nextT-=dt;
  while(nextT<=0 && cursor<fullText.length){
    cursor++;
    draw(cursor);
    nextT+=1/(8+Math.random()*6); // velocidad
  }
}

/* -------------------- CUES -------------------- */
const cues=[...CUES].sort((a,b)=>a.t-b.t);
let nextCue=0;

/* -------------------- LOOP -------------------- */
renderer.setAnimationLoop(()=>{
  if(video.readyState>=2) videoTex.needsUpdate=true;

  const t=video.currentTime;
  while(nextCue<cues.length && t>=cues[nextCue].t){
    setupText(cues[nextCue].text);
    nextCue++;
  }
  const dt=Math.max(0,t-lastT);
  lastT=t;
  step(dt);

  renderer.render(scene,camera);
});

/* -------------------- BOTONES -------------------- */
const btnStart=document.getElementById("start");
const btnAR=document.getElementById("enterAR");
const btnVR=document.getElementById("enterVR");

btnStart.onclick=async()=>{
  try{
    video.muted=false;
    video.volume=1.0;
    await video.play();   // üëà gesto de usuario ‚Üí audio permitido
    btnAR.disabled=false;
    btnVR.disabled=false;
    log("‚ñ∂ V√≠deo con sonido iniciado");
  }catch(e){log("Error v√≠deo");}
};

async function enter(mode){
  const s=await navigator.xr.requestSession(mode,{
    optionalFeatures:["local-floor","bounded-floor","hand-tracking"]
  });
  renderer.xr.setSession(s);
  overlay.style.display="none";
}

btnAR.onclick=()=>enter("immersive-ar");
btnVR.onclick=()=>enter("immersive-vr");

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>




